<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoMaker - Game Creator</title>
    <link rel="icon" type="image/webp" href="src/somaker.webp">

    <!-- <script src="https://unpkg.com/@solana/web3.js@^1.32.0/lib/index.iife.min.js" defer></script> -->
    <script src="js/solana-web3.js"></script>
    <!-- <script src="js/forge.min.js" defer></script> -->
    <!-- <script src="js/marked.min.js" defer></script> -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script src="js/game_tempates.js?id=884758573975873857" defer></script>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #121212;
            color: white;
        }
        header {
            background: #1E1E1E;
            padding: 15px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .container {
            display: flex;
            flex: 1;
        }
        .sidebar {
            width: 250px;
            background: #222;
            padding: 20px;
            box-shadow: 4px 0 6px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
        .sidebar h3 {
            cursor: pointer;
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar h3:hover {
            background: #444;
        }
        .sidebar .content {
            display: none;
            margin-top: 10px;
        }
        .sidebar .content li{
            cursor: pointer;
        }
        .sidebar .content.active {
            display: block;
        }
        .grid-box {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }
        .grid-box div {
            background: #333;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        .grid-box div:hover {
            transform: scale(1.05);
            background: #444;
        }
        .template-item {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        .template-item:hover {
            transform: scale(1.02);
            background: #444;
        }
        .template-item img {
            width: 100%;
            border-radius: 5px;
        }
        .template-item p {
            text-align: center;
            margin: 10px 0 0;
            font-size: 14px;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        .game-display, .code-box {
            flex: 1;
            background: #1E1E1E;
            color: white;
            padding: 20px;
            border-radius: 10px;
            overflow: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s;
        }
        .code-box {
            display: none;
            background: #000;
            color: lime;
            font-family: 'Courier New', monospace;
        }
        .bottom-input {
            display: flex;
            padding: 15px;
            background: #1E1E1E;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
        }
        .bottom-input input {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;
            background: #333;
            color: white;
        }
        .bottom-input button {
            padding: 10px 20px;
            margin-left: 10px;
            background: lime;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .bottom-input button:hover {
            background: #32CD32;
        }
        .launch-button {
            background: #FF5722;
            margin-top: 20px;
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .launch-button:hover {
            background: #E64A19;
        }
        .emoji {
            font-size: 24px;
        }




        /* Add all previous styles here */
        .profile-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            cursor: pointer;
            font-size: 24px;
        }
        /* .profile-popup {
            display: none;
            position: fixed;
            top: 60px;
            right: 20px;
            background: #333;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .profile-popup.active {
            display: block;
        } */


        /* Add all previous styles here */
        .loading-spinner {
            display: none;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid lime;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .iframe-container {
            width: 100%;
            height: 100%;
            border: 1px solid #444;
            border-radius: 5px;
            overflow: hidden;
        }
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .code-block {
            background: #1E1E1E;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            color: lime;
        }
    </style>
    <style>

        /* Add all previous styles here */
        .loading-spinner {
            display: none;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid lime;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .iframe-container {
            width: 100%;
            height: 100%;
            border: 1px solid #444;
            border-radius: 5px;
            overflow: hidden;
        }
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .code-box textarea {
            width: 100%;
            height: 100%;
            background: #000;
            color: lime;
            font-family: 'Courier New', monospace;
            border: none;
            padding: 10px;
            resize: none;
        }
        .selected-items {
            margin-top: 10px;
            padding: 10px;
            background: #333;
            border-radius: 5px;
        }
        .selected-items span {
            display: inline-block;
            margin: 5px;
            padding: 5px;
            background: #444;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
    <style>
        /* Smooth fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    
        /* Profile Popup Styling */
        /* .profile-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #1e1e2f, #3a3a5e);
            color: #fff;
            padding: 20px;
            width: 300px;
            border-radius: 12px;
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.3);
            font-family: 'Arial', sans-serif;
            display: none; 
            animation: fadeIn 0.5s ease-in-out;
            transition: all 0.3s ease-in-out;
        }
    
        .solana-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
    
        .solana-logo img {
            width: 50px;
            height: auto;
        } */

        .profile-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1E1E1E, #3A3A3A);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: none;
            z-index: 1000;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            font-size: 18px;
            color: white;
        }

        .solana-logo img {
            width: 50px;
            height: auto;
            margin-bottom: 10px;
        }
    
        /* Wallet Text */
        .profile-popup p {
            margin: 8px 0;
            font-size: 16px;
            display: flex;
            align-items: center;
        }
    
        /* Address & Balance Styling */
        #solanaAddress {
            font-weight: bold;
            color: #9efeff;
            word-break: break-all;
            margin-left: 8px;
        }
    
        #balance {
            font-weight: bold;
            color: #ffdd57;
            font-size: 18px;
        }
    
        /* Cool Emoji Icons */
        .emoji {
            margin-right: 8px;
        }
    
        /* Hover effect */
        .profile-popup:hover {
            /* transform: scale(1.05); */
            box-shadow: 0px 6px 20px rgba(0, 0, 0, 0.5);
        }
    </style>
    
    

    
</head>
<body>
    <header>SoMaker - AI Game Creator 🎮</header>
    <div class="profile-icon" onclick="toggleProfilePopup()">👤</div>
    <!-- <div class="profile-popup" id="profilePopup">
        <p>Solana Address: <span id="solanaAddress"></span></p>
    </div> -->
    <!-- Wallet Pop-up UI -->
    <div class="profile-popup" id="profilePopup">
        <span class="close-btn" onclick="closePopup()">✖</span>

        <div class="solana-logo">
            <img src="https://cryptologos.cc/logos/solana-sol-logo.png" alt="Solana Logo">
        </div>
        <p><span class="emoji">💰</span> Solana Address: <span id="solanaAddress"></span></p>
        <p><span class="emoji">⚡</span> <span id="balance">Balance: Loading...</span></p>
    </div>

    <div class="container">
        <div class="sidebar">

            <span class="home" onclick="goToHome()">🏠 Home</span>

            <!-- File Section -->
            <h3 onclick="toggleSection('file')">File 📁 <span>▼</span></h3>
            <div id="file" class="content">
                <ul>
                    <li onclick="newProject()">🆕 New Project</li>
                    <li onclick="saveProject()">💾 Save</li>
                    <li onclick="saveProjectAs()">💾 Save As...</li>
                    <li onclick="exportProject()">📤 Export</li>
                    <li onclick="importProject()">📥 Import</li>
                    <li onclick="undo()">↩️ Undo</li>
                    <li onclick="redo()">↪️ Redo</li>
                </ul>
            </div>

            <!-- Recent Projects Section -->
            <div class="recent-projects">
                <h3 onclick="toggleSection('projects')">Recent Projects 📂 <span>▼</span></h3>
                <div id="projects" class="content">
                    <ul id="projectList"></ul>
                </div>
            </div>

            <!-- Emojis Section -->
            <h3 onclick="toggleSection('emojis')">Emojis 😊 <span>▼</span></h3>
            <div id="emojis" class="content">
                <div class="grid-box">
                    <div onclick="toggleSelection('emojis', '😀')">😀</div>
                    <div onclick="toggleSelection('emojis', '😎')">😎</div>
                    <div onclick="toggleSelection('emojis', '👾')">👾</div>
                    <div onclick="toggleSelection('emojis', '🦄')">🦄</div>
                    <div onclick="toggleSelection('emojis', '🐉')">🐉</div>
                    <div onclick="toggleSelection('emojis', '🚀')">🚀</div>
                    <div onclick="toggleSelection('emojis', '🌈')">🌈</div>
                    <div onclick="toggleSelection('emojis', '🎨')">🎨</div>
                </div>
                <div class="selected-items" id="selectedEmojis"></div>
            </div>

            <!-- Platformers Section -->
            <h3 onclick="toggleSection('platformers')">Platformers 🏃‍♂️ <span>▼</span></h3>
            <div id="platformers" class="content">
                <div class="grid-box">
                    <div onclick="toggleSelection('platformers', '👤')">👤</div>
                    <div onclick="toggleSelection('platformers', '👥')">👥</div>
                    <div onclick="toggleSelection('platformers', '🔼')">🔼</div>
                    <div onclick="toggleSelection('platformers', '🔽')">🔽</div>
                    <div onclick="toggleSelection('platformers', '◀️')">◀️</div>
                    <div onclick="toggleSelection('platformers', '▶️')">▶️</div>
                </div>
                <div class="selected-items" id="selectedPlatformers"></div>
            </div>

            <!-- Effects Section -->
            <h3 onclick="toggleSection('effects')">Effects ✨ <span>▼</span></h3>
            <div id="effects" class="content">
                <div class="grid-box">
                    <div onclick="toggleSelection('effects', '💥')">💥</div>
                    <div onclick="toggleSelection('effects', '🔥')">🔥</div>
                    <div onclick="toggleSelection('effects', '💧')">💧</div>
                    <div onclick="toggleSelection('effects', '⚡')">⚡</div>
                </div>
                <div class="selected-items" id="selectedEffects"></div>
            </div>

            <!-- Templates Section -->
            <h3 onclick="toggleSection('templates')">Templates 📄 <span>▼</span></h3>
            <div id="templates" class="content">
                <!-- <div class="template-item" onclick="addTemplate('3-Way Race', '🏁', '<h1>3-Way Race</h1><p>Race against opponents in a thrilling 3-way competition!</p>')">
                    <div class="emoji">🏁</div>
                    <p>3-Way Race</p>
                </div>
                <div class="template-item" onclick="addTemplate('3D Race', '🚗', '<h1>3D Race</h1><p>Experience high-speed racing in a 3D environment!</p>')">
                    <div class="emoji">🚗</div>
                    <p>3D Race</p>
                </div>
                <div class="template-item" onclick="addTemplate('Gravity Game', '🌍', '<h1>Gravity Game</h1><p>Defy gravity and solve puzzles in space!</p>')">
                    <div class="emoji">🌍</div>
                    <p>Gravity Game</p>
                </div>
                <div class="template-item" onclick="addTemplate('Detection Game', '🔍', '<h1>Detection Game</h1><p>Find hidden objects and solve mysteries!</p>')">
                    <div class="emoji">🔍</div>
                    <p>Detection Game</p>
                </div>
                <div class="template-item" onclick="addTemplate('Fight Game', '🥊', '<h1>Fight Game</h1><p>Battle opponents and become the champion!</p>')">
                    <div class="emoji">🥊</div>
                    <p>Fight Game</p>
                </div> -->
            </div>

            <!-- Launch Button -->
            <button class="launch-button" onclick="launchGame()">Launch Game 🚀</button>
        </div>

        <div class="main-content">
            <div class="iframe-container" id="gameOutputContainer">
                <iframe id="gameOutput"></iframe>
            </div>
            <div class="code-box" id="codeOutput">
                <textarea id="codeTextarea"></textarea>
            </div>
        </div>
    </div>
    <div class="bottom-input">
        <input type="text" id="gamePrompt" placeholder="Enter your game prompt...">
        <button id="generateButton" onclick="generateGame()">Generate 🚀</button>
        <div class="loading-spinner" id="loadingSpinner"></div>
        <button onclick="toggleMode()">Toggle View 🔄</button>
    </div>

    <script>
        let showCode = false;
        let currentProject = null;
        var product_unique_id = "75hfru%r47gjtu5jreno4";

        // Toggle sidebar sections
        function toggleSection(id) {
            const section = document.getElementById(id);
            section.classList.toggle('active');
        }

        // Save game state to LocalStorage
        function saveGameState(projectName) {
            const gameOutput = document.getElementById('gameOutput').srcdoc;
            const codeOutput = document.getElementById('codeTextarea').value;

            const project = {
                name: projectName,
                gameOutput,
                codeOutput,
                timestamp: new Date().toISOString(),
            };

            // Save to LocalStorage
            localStorage.setItem(projectName, JSON.stringify(project));

            // Update recent projects list
            updateRecentProjects();
        }


        // Toggle sidebar sections
        function toggleSection(id) {
            const section = document.getElementById(id);
            section.classList.toggle('active');
        }

        // Create a new project
        function newProject() {
            currentProject = null;
            document.getElementById('gameOutput').srcdoc = '';
            document.getElementById('codeTextarea').value = '';
            alert('New project created!');
        }

        // Save the current project
        function saveProject() {
            if (!currentProject) {
                saveProjectAs();
                return;
            }

            const gameOutput = document.getElementById('gameOutput').srcdoc;
            const codeOutput = document.getElementById('codeTextarea').value;

            const project = {
                name: currentProject,
                gameOutput,
                codeOutput,
                timestamp: new Date().toISOString(),
            };

            localStorage.setItem(currentProject, JSON.stringify(project));
            alert('Project saved successfully!');
            updateRecentProjects();
        }

        // Save the current project with a new name
        function saveProjectAs() {
            const projectName = prompt('Enter a name for your project:');
            if (!projectName) return;

            currentProject = `project_${projectName}`;
            saveProject();
        }

        // Export the current project as a file
        function exportProject() {
            const gameOutput = document.getElementById('gameOutput').srcdoc;
            const blob = new Blob([gameOutput], { type: 'text/html' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = currentProject ? `${currentProject}.html` : 'project.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import a project from a file
        function importProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.html';

            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();

                reader.onload = (event) => {
                    const content = event.target.result;
                    document.getElementById('gameOutput').srcdoc = content;
                    document.getElementById('codeTextarea').value = content;
                    alert('Project imported successfully!');
                };

                reader.readAsText(file);
            };

            input.click();
        }


        // Undo and Redo stacks
        let undoStack = [];
        let redoStack = [];

        // Maximum number of undo/redo steps to store
        const MAX_STACK_SIZE = 30;

        // Save the current state to the undo stack
        function saveState() {
            const gameOutput = document.getElementById('gameOutput').srcdoc;
            const codeOutput = document.getElementById('codeTextarea').value;

            // Add the current state to the undo stack
            undoStack.push({ gameOutput, codeOutput });

            // Limit the stack size
            if (undoStack.length > MAX_STACK_SIZE) {
                undoStack.shift(); // Remove the oldest state
            }

            // Clear the redo stack when a new state is saved
            redoStack = [];
        }

        // Undo the last action
        function undo() {
            if (undoStack.length === 0) {
                alert('Nothing to undo!');
                return;
            }

            // Get the last state from the undo stack
            const lastState = undoStack.pop();

            // Save the current state to the redo stack
            const currentState = {
                gameOutput: document.getElementById('gameOutput').srcdoc,
                codeOutput: document.getElementById('codeTextarea').value,
            };
            redoStack.push(currentState);

            // Apply the last state
            document.getElementById('gameOutput').srcdoc = lastState.gameOutput;
            document.getElementById('codeTextarea').value = lastState.codeOutput;
        }

        // Redo the last undone action
        function redo() {
            if (redoStack.length === 0) {
                alert('Nothing to redo!');
                return;
            }

            // Get the last state from the redo stack
            const lastState = redoStack.pop();

            // Save the current state to the undo stack
            const currentState = {
                gameOutput: document.getElementById('gameOutput').srcdoc,
                codeOutput: document.getElementById('codeTextarea').value,
            };
            undoStack.push(currentState);

            // Apply the last state
            document.getElementById('gameOutput').srcdoc = lastState.gameOutput;
            document.getElementById('codeTextarea').value = lastState.codeOutput;
        }

        // Call saveState() whenever the gameOutput or codeTextarea changes
        document.getElementById('codeTextarea').addEventListener('input', () => {
            saveState();
        });

        // Call saveState() when the gameOutput is updated (e.g., after generating a game)
        function updateGameOutput(content) {
            document.getElementById('gameOutput').srcdoc = content;
            saveState();
        }


        // Load game state from LocalStorage
        function loadGameState(projectName) {
            const project = JSON.parse(localStorage.getItem(projectName));
            if (project) {
                document.getElementById('gameOutput').srcdoc = project.gameOutput;
                document.getElementById('codeTextarea').value = project.codeOutput;

                /* const codeTextarea = document.getElementById('codeTextarea');
                const gameOutput = document.getElementById('gameOutput');

                codeTextarea.addEventListener('input', () => {
                    gameOutput.srcdoc = codeTextarea.value;
                }); */
                currentProject = projectName;
            }
        }

        // Update recent projects list in the sidebar
        function updateRecentProjects() {
            const projectList = document.getElementById('projectList');
            projectList.innerHTML = '';

            const projects = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('project_')) {
                    const project = JSON.parse(localStorage.getItem(key));
                    projects.push(project);
                }
            }

            // Sort projects by timestamp (newest first)
            projects.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Display projects in the list
            projects.forEach((project) => {
                const li = document.createElement('li');
                li.textContent = project.name;
                li.onclick = () => loadGameState(project.name);
                projectList.appendChild(li);
            });
        }

        // Generate a unique project name
        function generateProjectName() {
            let projectCount = 0;
            while (localStorage.getItem(`project_${projectCount}`)) {
                projectCount++;
            }
            return `project_${projectCount}`;
        }

        // Add template to gameOutput and codeOutput
        function addTemplate(title, emoji, htmlContent) {
            const gameOutput = document.getElementById('gameOutput');
            // const codeOutput = document.getElementById('codeOutput');
            const codeOutput = document.getElementById('codeTextarea');

            // Add HTML to gameOutput
            gameOutput.srcdoc = htmlContent;

            // Add HTML code to codeOutput
            codeOutput.value = htmlContent;

            // Auto-save the game state
            if (!currentProject) {
                currentProject = generateProjectName();
            }
            saveGameState(currentProject);
        }

        // Generate game based on prompt
        /* function generateGame() {
            const prompt = document.getElementById("gamePrompt").value;
            const gameHTML = `<h2>${prompt}</h2><p>Sample game generated... 🎉</p>`;
            document.getElementById("gameOutput").innerHTML = gameHTML;
            document.getElementById("codeOutput").textContent = gameHTML;

            // Auto-save the game state
            if (!currentProject) {
                currentProject = generateProjectName();
            }
            saveGameState(currentProject);
        }
 */
        // Toggle between game and code view
        function toggleMode() {
            showCode = !showCode;
            // document.getElementById("gameOutput").style.display = showCode ? "none" : "block";
            document.getElementById("gameOutputContainer").style.display = showCode ? "none" : "block";
            document.getElementById("codeOutput").style.display = showCode ? "block" : "none";
        }

        // Launch game
        // function launchGame() {
        //     alert("Game launched! 🎮 - Not allowed Yet.");
        // }

        // Launch game
        async function launchGame() {
            const code = document.getElementById('codeTextarea').value;

            if (!code) {
                alert('Please generate or write some code before launching!');
                return;
            }

            try {
                const response = await fetch(window.NODE_URL+'/launch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code }),
                });

                if (!response.ok) {
                    throw new Error('Failed to launch game');
                }

                const data = await response.json();
                const projectLink = data.link;

                // Display the link to the user
                alert(`Game launched successfully! 🎮\nShare this link to play: ${projectLink}`);

                // Call the blockchain function to share the game
                try {
                    await d_post_sharer({
                        metadata: {
                            title: 'New Game Launched',
                            content: `Check out my new game:\n\n{{element|type=iframe|src=${projectLink}}}`,
                            image_url: "",
                            author: 'Game Creator',
                        },
                    });
                } catch (error) {
                    console.error('Blockchain integration failed:', error);
                    alert('Game launched and stored on the server, but blockchain integration failed - Check console for details. You can still share the link to play: ' + projectLink);
                }

                // Open the game in a new tab
                window.open(projectLink, '_blank');
            } catch (error) {
                console.error('Error launching game:', error);
                alert('Failed to launch game. Please try again.');
            }
        }

        function closePopup() {
            document.getElementById('profilePopup').style.display = 'none';
        }

        // Close when clicking outside the popup
        /* document.addEventListener('click', function(event) {
            const popup = document.getElementById('profilePopup');
            if (event.target !== popup && !popup.contains(event.target)) {
                popup.style.display = 'none';
            }
        }); */

        function goToHome() {
            window.location.href = "index.html";
        }

        
async function d_post_sharer(entry){
    post = entry.metadata;

    await make_some_post({
        title: post.title,
        content: post.content,
        image_url: post.image_url,
        author: post.author,
        others: JSON.stringify({
            nft: "false",
            nude: "false",
            encryption: "", // encryption: "AES256",
            share: "true",
            comment: "false",
            main_post_id: "", 
            category: "entertainment", // "technology",
            hash: "",
            pubkey: keypair.publicKey.toBase58(),
            ip: "", // TODO: we would get this...
            geo: ",", //TODO: We would get this and it would be the LAT,LONG
            product_id: product_unique_id,
            others: ""
        })
    });
}


async function make_some_post({
    title,
    content,
    image_url,
    author,
    // author = document.getElementById("author").value || keypair.publicKey.toBase58(),
    others = {
        nft: "false",
        nude: "false",
        encryption: "",
        share: "false",
        comment: "false",
        main_post_id: "", 
        category: "entertainment",
        hash: "",
        pubkey: keypair.publicKey.toBase58(),
        ip: "",
        geo: "LAT, LONG",
        product_id: product_unique_id,
        others: ""
    },
    encryption_type = "" // New parameter
} = {}) {
    try {
        // Encrypt private key
        const encryptedPrivateKey = await encryptPrivateKey(serverPublicKeyPem, JSON.stringify(Array.from(keypair.secretKey)));

        // Construct postData
        const postData = {
            encryptedPrivateKey: encryptedPrivateKey,
            publicKey: serverPublicKeyPem,
            title: title,
            content: content,
            image_url: image_url,
            author: author,
            date: new Date().toISOString(),
            network_pref: network, // the network preference or network used on the frontend...
            others: typeof others != "string" ? JSON.stringify(others) : others, // Ensure "others" is a JSON structure
            // encryption_type: encryption_type // Include encryption_type in the payload
        };

        console.log("Post Data:", postData);

        // Send data to server
        const response = await fetch(NODE_URL+"/api/create-post", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(postData)
        });

        // Handle response
        const result = await response.json();

        // Determine which pop-up to show based on the response
        if (result.error) {
            showPopup("error", "Error", `Error: ${result.error}. Details: ${result.details || "No additional details provided."}`);
            alert("Raw Output: " + JSON.stringify(result));
        } else if (result.edit_key && result.message && result.signature) {
            showPopup("success", "Success", "Your post has been successfully created!", result);
        } else {
            showPopup("warning", "Warning", "Unexpected response from the server.");
            alert("Raw Output: " + JSON.stringify(result));
        }
        // alert("Raw Output: "+JSON.stringify(result));

    } catch (error) {
        console.error("Error submitting post:", error);
        alert("Failed to submit post.");
    }
}



async function encryptPrivateKey(publicKeyPem, privateKey) {
    // Convert the server's public key from PEM format to a Forge public key object
    const publicKey = forge.pki.publicKeyFromPem(publicKeyPem);
    
    // Split the private key string into chunks of 10 characters
    const privateKeyChunks = privateKey.match(/.{1,10}/g); // This splits the string into chunks of 10 characters

    // Encrypt each chunk using RSA-OAEP
    const encryptedChunks = await Promise.all(privateKeyChunks.map(async (chunk) => {
        try {
            return publicKey.encrypt(chunk, 'RSA-OAEP');
        } catch (error) {
            console.error("Error encrypting chunk:", error);
            throw error;
        }
    }));

    // Return a JSON string containing both the chunks and the encrypted chunks
    const result = {
        // originalChunks: privateKeyChunks,
        encryptedChunks: encryptedChunks
    };

    return JSON.stringify(result);
}


// Function to show a pop-up
function showPopup(type, title, message, extra_data=null, stay_time=5000) {
    ensurePopupHTML();

    const popup = document.createElement("div");
    popup.className = `popup ${type}`;
    popup.innerHTML = `
        <div class="popup-icon">${getSVGIcon(type)}</div>
        <div class="popup-content">
            <strong>${title}</strong>
            <p>${message}</p>
        </div>
        <button class="popup-close" aria-label="Close">&times;</button>
    `;
    
    // Add the popup to the container
    const container = document.getElementById("popup-container");
    container.appendChild(popup);

    // Add event listener for close button
    const closeButton = popup.querySelector(".popup-close");
    closeButton.addEventListener("click", () => popup.remove());

    // Automatically remove pop-up after 5 seconds if not manually closed
    setTimeout(() => {
        if (popup.parentElement) popup.remove();

        if(type="success" && extra_data != null){
            // Ask the user if they want to download the editing keys
            const userWantsToDownload = confirm(
                "Your post editing keys are ready. Would you like to download them now?"
            );
            // Downloading the edit keys and reloading the page...
            if (userWantsToDownload) {
                downloadDJSON(extra_data);
                // Reload the page with `page_shuffle=false`
                shufflePageReload("false");
            }
        }
        
    }, stay_time);
}


// Function to inject pop-up HTML and styles if not already on the page
function ensurePopupHTML() {
    if (!document.getElementById("popup-container")) {
        const container = document.createElement("div");
        container.id = "popup-container";
        container.style.position = "fixed";
        container.style.top = "10px";
        container.style.right = "10px";
        container.style.width = "320px";
        container.style.zIndex = "9999";
        document.body.appendChild(container);

        // Inject styles directly into the page
        const style = document.createElement("style");
        style.textContent = `
            #popup-container {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .popup {
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: #fff;
                color: #000;
                border-radius: 8px;
                padding: 15px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                border-left: 5px solid;
                animation: fadeIn 0.3s ease-in-out;
                position: relative;
            }
            .popup.success { border-color: #28a745; }
            .popup.warning { border-color: #ffc107; }
            .popup.error { border-color: #dc3545; }
            .popup-icon {
                flex-shrink: 0;
                margin-right: 15px;
            }
            .popup-content {
                flex: 1;
            }
            .popup-content strong {
                display: block;
                font-size: 1rem;
                margin-bottom: 5px;
            }
            .popup-content p {
                font-size: 0.875rem;
                margin: 0;
            }
            .popup-close {
                background: none;
                border: none;
                broder: 2px dotted #00A;
                font-size: 1.2rem;
                color: #333;
                cursor: pointer;
                margin-left: 10px;
                transition: color 0.2s;
            }
            .popup-close:hover {
                color: #000;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);
    }
}





        
    </script>


<script>
    // let showCode = false;
    // let currentProject = null;

    // Generate a default Solana public address
    /* function generateSolanaAddress() {
        const chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
        let address = 'Solana';
        for (let i = 0; i < 32; i++) {
            address += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return address;
    } */

    // function goToHome() {
    //     window.location.href = "index.html";
    // }

    // Save Solana address to LocalStorage
    /* function saveSolanaAddress() {
        if (!localStorage.getItem('solanaAddress')) {
            const address = generateSolanaAddress();
            localStorage.setItem('solanaAddress', address);
        }
    }

    // Display Solana address in the profile popup
    function displaySolanaAddress() {
        const address = localStorage.getItem('solanaAddress');
        document.getElementById('solanaAddress').textContent = address;
    }
 */
    // Toggle profile popup
    function toggleProfilePopup() {
        const popup = document.getElementById('profilePopup');
        popup.style.display = 'block';
        // popup.classList.toggle('active');

        // profilePopup.style.display = 'block';
        // popup.style.display = (popup.style.display === "block") ? 'none' : "block";
        
    }

    // Extract HTML, CSS, and JavaScript from the AI response
    function extractCodeBlocks(response) {
        const htmlRegex = /```html([\s\S]*?)```/;
        const cssRegex = /```css([\s\S]*?)```/;
        const jsRegex = /```javascript([\s\S]*?)```/;

        const html = response.match(htmlRegex)?.[1]?.trim() || '';
        const css = response.match(cssRegex)?.[1]?.trim() || '';
        const js = response.match(jsRegex)?.[1]?.trim() || '';

        return { html, css, js };
    }

    // let URL__ = window.NODE_URL;

    // // Send game prompt to the Node server
    // async function generateGame() {
    //     const prompt = document.getElementById("gamePrompt").value;
    //     const solanaAddress = localStorage.getItem('solanaAddress');

    //     if (!prompt) {
    //         alert("Please enter a game prompt!");
    //         return;
    //     }

    //     // Show loading spinner and disable generate button
    //     document.getElementById('generateButton').style.display = 'none';
    //     document.getElementById('loadingSpinner').style.display = 'inline-block';

    //     try {
    //         const response = await fetch(URL__+'/generate', {
    //             method: 'POST',
    //             headers: {
    //                 'Content-Type': 'application/json',
    //             },
    //             body: JSON.stringify({ prompt, solanaAddress }),
    //         });

    //         if (!response.ok) {
    //             throw new Error('Failed to generate game content');
    //         }

    //         const data = await response.json();
    //         const { html, css, js } = extractCodeBlocks(data.content);

    //         // Render HTML in iframe
    //         const iframe = document.getElementById('gameOutput');
            

    //         let fullHTML = html;
    //         // If the HTML contains a </head> tag, insert the CSS and JS just before it.
    //         // if (fullHTML.includes('</head>')) {
    //         // } 
    //         // else {
    //         //     // If not, prepend them to the HTML.
    //         // }

    //         iframe.srcdoc = fullHTML;


    //         // Display HTML code in codeOutput
    //         // document.getElementById('codeOutput').textContent = html;
    //         document.getElementById('codeOutput').textContent = fullHTML;

    //         // Display other code blocks (CSS, JS) in otherCodeOutput
    //         const otherCode = [];
    //         if (css) otherCode.push(`/* CSS */\n${css}`);
    //         if (js) otherCode.push(`/* JavaScript */\n${js}`);
    //         document.getElementById('otherCodeOutput').textContent = otherCode.join('\n\n');

    //         // Auto-save the game state
    //         if (!currentProject) {
    //             currentProject = generateProjectName();
    //         }
    //         saveGameState(currentProject);
    //     } catch (error) {
    //         console.error('Error:', error);
    //         alert('Failed to generate game content. Please try again.');
    //     } finally {
    //         // Hide loading spinner and show generate button
    //         document.getElementById('loadingSpinner').style.display = 'none';
    //         document.getElementById('generateButton').style.display = 'inline-block';
    //     }
    // }




</script>


    <script>
        // let showCode = false;
        // let currentProject = null;
        const selectedItems = {
            emojis: new Set(),
            platformers: new Set(),
            effects: new Set(),
        };

        // Toggle sidebar sections
        function toggleSection(id) {
            const section = document.getElementById(id);
            section.classList.toggle('active');
        }

        // Toggle selection of items (emojis, platformers, effects)
        function toggleSelection(category, item) {
            if (selectedItems[category].has(item)) {
                selectedItems[category].delete(item);
            } else {
                selectedItems[category].add(item);
            }
            updateSelectedItems(category);
        }

        // Update the selected items list
        function updateSelectedItems(category) {
            const selectedItemsDiv = document.getElementById(`selected${category.charAt(0).toUpperCase() + category.slice(1)}`);
            selectedItemsDiv.innerHTML = Array.from(selectedItems[category]).map(item => `<span onclick="toggleSelection('${category}', '${item}')">${item}</span>`).join('');
        }


        //TODO::: SOME IMPROVEMENTS WOULD HAPPEN HERE... THE NEED FOR SOME FIXES...

        // Link codeTextarea and gameOutput
        const codeTextarea = document.getElementById('codeTextarea');
        const gameOutput = document.getElementById('gameOutput');

        codeTextarea.addEventListener('input', () => {
            gameOutput.srcdoc = codeTextarea.value;
        });

        // Generate game based on prompt
        async function generateGame() {
            const prompt = document.getElementById("gamePrompt").value;
            const solanaAddress = localStorage.getItem('solanaAddress');

            if (!prompt) {
                alert("Please enter a game prompt!");
                return;
            }

            // Show loading spinner and disable generate button
            document.getElementById('generateButton').style.display = 'none';
            document.getElementById('loadingSpinner').style.display = 'inline-block';

            const gameOutput = document.getElementById('gameOutput');
            // const codeOutput = document.getElementById('codeOutput');
            const codeOutput = document.getElementById('codeTextarea');

            console.log("the details code: "+codeOutput.value);
            console.log("the details game - iframe: "+gameOutput.srcdoc);

            try {
                const response = await fetch(window.NODE_URL+'/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt,
                        solanaAddress,
                        code_state: codeTextarea.value,
                        emojis: Array.from(selectedItems.emojis),
                        platformers: Array.from(selectedItems.platformers),
                        effects: Array.from(selectedItems.effects),
                    }),
                });

                if (!response.ok) {
                    throw new Error('Failed to generate game content');
                }

                const data = await response.json();
                const { html } = extractCodeBlocks(data.content);

                // Update codeTextarea and gameOutput
                codeTextarea.value = html;
                gameOutput.srcdoc = html;

                // Auto-save the game state
                if (!currentProject) {
                    currentProject = generateProjectName();
                }
                saveGameState(currentProject);
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate game content. Please try again.');
            } finally {
                // Hide loading spinner and show generate button
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('generateButton').style.display = 'inline-block';
            }
        }

        // On page load, initialize Solana address and load recent projects
        window.onload = () => {
            // saveSolanaAddress();
            // displaySolanaAddress();
            updateRecentProjects(); // load recent projects
            generateTemplateItems(); // load the templates


            const projects = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('project_')) {
                    const project = JSON.parse(localStorage.getItem(key));
                    projects.push(project);
                }
            }
            if (projects.length > 0) {
                console.log("loading most recent project...");
                const mostRecentProject = projects.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                loadGameState(mostRecentProject.name);
            }else{
                console.log("loading a random template");
                loadRandomTemplate();
            }
        };
    </script>

<script src="js/game_dashboard.js?id=24758275827" defer></script>

</body>
</html>